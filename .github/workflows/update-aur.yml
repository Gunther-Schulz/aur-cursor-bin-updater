name: Update AUR Package

on:
  schedule:
    - cron: '0 * * * *'  # Run every hour
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate PKGBUILD
        run: |
          sudo apt-get install libarchive-tools
          URL=https://cursor.com/api/download?platform=linux-x64&releaseTrack=stable
          pkgver=$(curl $URL | jq .version | tr -d \")
          _commit=$(curl $URL | jq .commitSha | tr -d \" )
          curl https://downloads.cursor.com/production/${_commit}/linux/x64/deb/amd64/deb/cursor_${pkgver}_amd64.deb -o /tmp/a.tar.xz
          _sha=$(sha512sum /tmp/a.tar.xz | cut -d ' ' -f 1)
          code=$(bsdtar xOf /tmp/a.tar.xz data.tar.xz | bsdtar xOf - ./usr/share/cursor/resources/app/product.json|jq .vscodeVersion | tr -d \")
          _electron=electron$(curl -L https://github.com/microsoft/vscode/raw/refs/tags/${code}/package-lock.json|jq -r '.packages."".devDependencies.electron |split(".")|.[0]')
          _node=20
          sed PKGBUILD.sed \
            -e "s/^pkgver=.*/pkgver=${pkgver}/" \
            -e "s/^_commit=.*/_commit=${_commit}/" \
            -e "s/^sha512sum\[0\]=.*/sha512sum\[0\]=${_sha}/" \
            -e "s/^_electron=.*/_electron=${_electron}/" \
          > PKGBUILD
          cat PKGBUILD
          false #todo: stop CI by diff command's exit code if update is not needed.

      - name: Commit changes
        if: steps.update_needed.outputs.update_needed == 'true'
        run: |
          # Clean up untracked files
          git clean -fd

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # Add PKGBUILD
          git add PKGBUILD
          git commit -m "Update PKGBUILD to version ${{ fromJson(steps.check.outputs.check_output).new_version }} (commit ${{ fromJson(steps.check.outputs.check_output).new_commit }})" || echo "No changes to commit"
          
          # Only push if not in DEBUG mode
          if [[ "${{ env.DEBUG }}" != "true" ]]; then
            echo "Pushing changes to remote repository..."
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }}
          else
            echo "DEBUG mode: Skipping git push"
            echo "Local commit created successfully"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check branch and continue or stop workflow
        if: steps.update_needed.outputs.update_needed == 'true'
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            echo "On development branch, stopping workflow"
            exit 0
          else
            echo "On main branch, continuing workflow"
          fi

      - name: Install SSH Key
        if: steps.update_needed.outputs.update_needed == 'true' && github.ref != 'refs/heads/development'
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: replace

      - name: Publish AUR package
        if: steps.update_needed.outputs.update_needed == 'true' && github.ref != 'refs/heads/development'
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: cursor-bin
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ fromJson(steps.check.outputs.check_output).new_version }} (commit ${{ fromJson(steps.check.outputs.check_output).new_commit }})"
          allow_empty_commits: false
          ssh_keyscan_types: rsa,ecdsa,ed25519
          assets: rg.sh

      - name: Validate PKGBUILD (for testing)
        if: env.DEBUG == 'true'
        run: |
          echo "::group::PKGBUILD Validation"
          python validate_pkgbuild.py
          echo "::endgroup::"

      - name: Summary
        run: |
          echo "::group::Workflow Summary"
          echo "Update needed: ${{ fromJson(steps.check.outputs.check_output).update_needed }}"
          echo "New version: ${{ fromJson(steps.check.outputs.check_output).new_version }}"
          echo "New commit: ${{ fromJson(steps.check.outputs.check_output).new_commit }}"
          echo "PKGBUILD updated and published to AUR"
          echo "::endgroup::"
